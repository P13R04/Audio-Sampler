<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Web Component - Audio Sampler</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #e0e0e0;
    }
    
    h1 {
      color: #a78bfa;
      border-bottom: 2px solid #a78bfa;
      padding-bottom: 10px;
    }
    
    .section {
      background: #16213e;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      border: 1px solid #2e3a59;
    }
    
    .section h2 {
      color: #67e8f9;
      margin-top: 0;
    }
    
    .info {
      background: #0f3460;
      padding: 15px;
      border-left: 4px solid #a78bfa;
      margin: 10px 0;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    
    .status.success {
      background: #064e3b;
      color: #6ee7b7;
      border: 1px solid #10b981;
    }
    
    .status.error {
      background: #7f1d1d;
      color: #fca5a5;
      border: 1px solid #dc2626;
    }
    
    .status.info {
      background: #1e3a8a;
      color: #93c5fd;
      border: 1px solid #3b82f6;
    }
    
    code {
      background: #0f172a;
      padding: 2px 6px;
      border-radius: 3px;
      color: #a78bfa;
      font-family: 'Courier New', monospace;
    }
    
    button {
      background: linear-gradient(180deg, #7c3aed, #5b21b6);
      color: white;
      border: 1px solid #6d28d9;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
    }
    
    button:hover {
      background: linear-gradient(180deg, #8b5cf6, #6d28d9);
    }
    
    audio-sampler-app {
      display: block;
      margin: 20px 0;
    }
    
    .logs {
      background: #0f172a;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid #1e293b;
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .timestamp {
      color: #64748b;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <h1>üéµ Test Web Component Audio Sampler</h1>
  
  <div class="section">
    <h2>üìã Instructions de test</h2>
    <div class="info">
      <strong>Pr√©requis :</strong> Le serveur API doit √™tre lanc√© sur <code>http://localhost:3000</code>
      <br><br>
      <strong>Pour lancer le serveur :</strong>
      <br>1. Ouvrir un terminal dans le dossier du projet
      <br>2. Ex√©cuter : <code>npm start</code>
      <br>3. V√©rifier que "Server running on port 3000" s'affiche
    </div>
  </div>

  <div class="section">
    <h2>üîß Tests API et Modules</h2>
    <button onclick="testAPI()">Tester l'API</button>
    <button onclick="testModules()">Tester les modules</button>
    <button onclick="clearLogs()">Effacer les logs</button>
    <div id="test-status"></div>
    <div class="logs" id="logs"></div>
  </div>

  <div class="section">
    <h2>üéõÔ∏è Web Component : &lt;audio-sampler-app&gt;</h2>
    <div class="info">
      Le composant ci-dessous encapsule le sampler complet dans un Shadow DOM.
      <br>Il devrait afficher la m√™me interface que <code>index.html</code> avec :
      <ul style="margin: 10px 0 0 20px;">
        <li>Une topbar avec s√©lecteur de preset, layout clavier et th√®me</li>
        <li>Une grille 4√ó4 de pads</li>
        <li>Une waveform interactive avec trim bars</li>
        <li>Un playhead anim√© lors de la lecture</li>
      </ul>
    </div>
    
    <!-- LE WEB COMPONENT -->
    <audio-sampler-app></audio-sampler-app>
  </div>

  <div class="section">
    <h2>üß™ Tests interactifs</h2>
    <div class="info">
      <strong>Tests √† effectuer :</strong>
      <ol style="margin: 10px 0 0 20px; line-height: 2;">
        <li>‚úÖ Le preset par d√©faut se charge automatiquement</li>
        <li>‚úÖ Cliquer sur un pad ‚Üí le son joue</li>
        <li>‚úÖ Utiliser le clavier (touches affich√©es sur les pads)</li>
        <li>‚úÖ Changer de preset ‚Üí la grille se met √† jour</li>
        <li>‚úÖ Changer de layout clavier (QWERTY ‚Üî AZERTY)</li>
        <li>‚úÖ Changer de th√®me ‚Üí les couleurs changent</li>
        <li>‚úÖ Cliquer sur un pad ‚Üí la waveform s'affiche</li>
        <li>‚úÖ Jouer un son ‚Üí le playhead (barre blanche) se d√©place</li>
        <li>‚úÖ D√©placer les trim bars ‚Üí le son se d√©coupe</li>
        <li>üéôÔ∏è Boutons "Enregistrer" ‚Üí "Stop" ‚Üí "Lecture" ‚Üí "Sauvegarder"</li>
        <li>üéõÔ∏è Boutons "Ajouter un son" et "Cr√©er preset" disponibles</li>
      </ol>
    </div>
    
    <button onclick="testComponentAPI()">Tester l'API du composant</button>
    <button onclick="testRecorder()">Tester l'enregistreur</button>
    <div id="component-test-results"></div>
  </div>

  <div class="section">
    <h2>üìä Comparaison avec index.html</h2>
    <div class="info">
      <strong>Pour comparer :</strong>
      <br>1. Ouvrir <a href="http://localhost:8080" target="_blank" style="color: #67e8f9;">http://localhost:8080</a> (page principale)
      <br>2. Comparer avec cette page (web component)
      <br><br>
      <strong>Diff√©rences attendues :</strong>
      <ul style="margin: 10px 0 0 20px;">
        <li>‚úÖ M√™me fonctionnalit√©s dans les deux versions</li>
        <li>‚úÖ Web component isol√© dans Shadow DOM (styles encapsul√©s)</li>
        <li>‚úÖ Web component peut √™tre int√©gr√© dans n'importe quelle page</li>
        <li>‚ö†Ô∏è Le composant <code>&lt;audio-sampler&gt;</code> (enregistrement) fonctionne dans les deux</li>
      </ul>
    </div>
  </div>

  <!-- Import du web component -->
  <script type="module">
    // Cache busting pour forcer le rechargement des modules
    const timestamp = Date.now();
    const script1 = document.createElement('script');
    script1.type = 'module';
    script1.src = `js/sampler-component.js?v=${timestamp}`;
    document.head.appendChild(script1);
  </script>
  
  <script type="module">
    // Syst√®me de logging
    const logsDiv = document.getElementById('logs');
    const statusDiv = document.getElementById('test-status');
    
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const timestamp = document.createElement('span');
      timestamp.className = 'timestamp';
      timestamp.textContent = new Date().toLocaleTimeString();
      const text = document.createElement('span');
      text.style.color = type === 'error' ? '#fca5a5' : type === 'success' ? '#6ee7b7' : '#93c5fd';
      text.textContent = message;
      entry.appendChild(timestamp);
      entry.appendChild(text);
      logsDiv.appendChild(entry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(`[${type}]`, message);
    }
    
    function showStatus(message, type = 'info') {
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    window.clearLogs = () => {
      logsDiv.innerHTML = '';
      statusDiv.innerHTML = '';
    };
    
    // Test de l'API
    window.testAPI = async () => {
      log('üîç Test de l\'API REST...', 'info');
      showStatus('Test en cours...', 'info');
      
      try {
        log('Requ√™te GET http://localhost:3000/api/presets', 'info');
        const response = await fetch('http://localhost:3000/api/presets');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        log(`‚úÖ R√©ponse re√ßue: ${data.length} presets`, 'success');
        
        data.forEach((preset, i) => {
          log(`  Preset ${i + 1}: "${preset.name}" (${preset.samples?.length || 0} samples)`, 'info');
        });
        
        showStatus(`‚úÖ API fonctionnelle : ${data.length} presets disponibles`, 'success');
        
      } catch (err) {
        log(`‚ùå Erreur: ${err.message}`, 'error');
        showStatus(`‚ùå Erreur API: ${err.message}. V√©rifiez que le serveur est lanc√© (npm start)`, 'error');
      }
    };
    
    // Test des modules
    window.testModules = async () => {
      log('üîç Test des modules JavaScript...', 'info');
      
      try {
        log('Import de presets-manager.js...', 'info');
        const presetsModule = await import('./js/presets-manager.js');
        log(`‚úÖ Module charg√©, exports: ${Object.keys(presetsModule).join(', ')}`, 'success');
        
        log('Import de theme-manager.js...', 'info');
        const themeModule = await import('./js/theme-manager.js');
        log(`‚úÖ Module charg√©, ${Object.keys(themeModule.themes).length} th√®mes disponibles`, 'success');
        
        log('Import de keyboard-manager.js...', 'info');
        const keyboardModule = await import('./js/keyboard-manager.js');
        log(`‚úÖ Module charg√©`, 'success');
        
        log('Import de waveform-renderer.js...', 'info');
        const waveformModule = await import('./js/waveform-renderer.js');
        log(`‚úÖ Module charg√©`, 'success');
        
        showStatus('‚úÖ Tous les modules sont fonctionnels', 'success');
        
      } catch (err) {
        log(`‚ùå Erreur: ${err.message}`, 'error');
        showStatus(`‚ùå Erreur de chargement des modules: ${err.message}`, 'error');
      }
    };
    
    // Test de l'API du composant
    window.testComponentAPI = () => {
      log('üîç Test de l\'API du Web Component...', 'info');
      const resultsDiv = document.getElementById('component-test-results');
      const component = document.querySelector('audio-sampler-app');
      
      if (!component) {
        resultsDiv.innerHTML = '<div class="status error">‚ùå Composant non trouv√©</div>';
        log('‚ùå Composant audio-sampler-app non trouv√©', 'error');
        return;
      }
      
      log('‚úÖ Composant trouv√©', 'success');
      log(`Shadow DOM: ${component.shadowRoot ? 'Oui' : 'Non'}`, component.shadowRoot ? 'success' : 'error');
      
      if (component.shadowRoot) {
        const elements = {
          'presetSelect': component.shadowRoot.getElementById('presetSelect'),
          'buttonsContainer': component.shadowRoot.getElementById('buttonsContainer'),
          'topbar': component.shadowRoot.getElementById('topbar'),
          'status': component.shadowRoot.getElementById('status'),
          'error': component.shadowRoot.getElementById('error'),
          'audio-sampler': component.shadowRoot.querySelector('audio-sampler')
        };
        
        let html = '<div class="status info"><strong>√âl√©ments du Shadow DOM :</strong><ul style="margin: 10px 0 0 20px;">';
        
        Object.entries(elements).forEach(([name, el]) => {
          const status = el ? '‚úÖ' : '‚ùå';
          html += `<li>${status} ${name}</li>`;
          log(`${status} ${name}`, el ? 'success' : 'error');
        });
        
        html += '</ul></div>';
        resultsDiv.innerHTML = html;
        
        // Compter les pads
        const pads = component.shadowRoot.querySelectorAll('.pad-btn');
        log(`üìä ${pads.length} pads trouv√©s`, pads.length > 0 ? 'success' : 'error');
        
        // V√©rifier le composant audio-sampler
        const recorder = component.shadowRoot.querySelector('audio-sampler');
        if (recorder) {
          log('‚úÖ Composant <audio-sampler> (enregistreur) pr√©sent', 'success');
        } else {
          log('‚ùå Composant <audio-sampler> manquant', 'error');
        }
      }
    };
    
    // Test du composant d'enregistrement
    window.testRecorder = () => {
      log('üîç Test du composant d\'enregistrement...', 'info');
      const component = document.querySelector('audio-sampler-app');
      
      if (!component || !component.shadowRoot) {
        log('‚ùå Composant principal non trouv√©', 'error');
        return;
      }
      
      const recorder = component.shadowRoot.querySelector('audio-sampler');
      
      if (!recorder) {
        log('‚ùå Composant <audio-sampler> non trouv√© dans le Shadow DOM', 'error');
        return;
      }
      
      log('‚úÖ Composant <audio-sampler> trouv√©', 'success');
      
      // V√©rifier le Shadow DOM de l'enregistreur
      if (recorder.shadowRoot) {
        log('‚úÖ Shadow DOM de l\'enregistreur pr√©sent', 'success');
        
        const buttons = {
          'record': recorder.shadowRoot.getElementById('record'),
          'stop': recorder.shadowRoot.getElementById('stop'),
          'play': recorder.shadowRoot.getElementById('play'),
          'save': recorder.shadowRoot.getElementById('save')
        };
        
        Object.entries(buttons).forEach(([name, btn]) => {
          log(`${btn ? '‚úÖ' : '‚ùå'} Bouton "${name}"`, btn ? 'success' : 'error');
        });
        
        const canvas = recorder.shadowRoot.getElementById('wave');
        log(`${canvas ? '‚úÖ' : '‚ùå'} Canvas waveform`, canvas ? 'success' : 'error');
        
        log('üí° Cliquez sur "Enregistrer" pour tester l\'enregistrement audio', 'info');
      } else {
        log('‚ùå Shadow DOM de l\'enregistreur manquant', 'error');
      }
    };
    
    // Auto-test au chargement
    window.addEventListener('load', () => {
      log('üöÄ Page charg√©e, attente du composant...', 'info');
      
      // Attendre que le composant soit connect√©
      setTimeout(() => {
        const component = document.querySelector('audio-sampler-app');
        if (component && component.shadowRoot) {
          log('‚úÖ Web Component initialis√© avec succ√®s', 'success');
        } else {
          log('‚ö†Ô∏è Web Component non initialis√©', 'error');
        }
      }, 1000);
    });
  </script>
</body>
</html>
